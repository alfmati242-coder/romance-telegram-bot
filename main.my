from telegram import Update
from telegram.ext import ApplicationBuilder, MessageHandler, CommandHandler, ContextTypes, filters
from openai import OpenAI
import os

# -------------------
# ZMIENNE ≈öRODOWISKOWE
# -------------------
BOT_TOKEN = os.getenv("BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

# Inicjalizacja klienta OpenAI
client = OpenAI(api_key=OPENAI_API_KEY)

# -------------------
# PROMPT ‚Äì osobowo≈õƒá bota
# -------------------
SYSTEM_PROMPT = (
    "Jeste≈õ doros≈Çym chatbotem AI do rozm√≥w romantycznych i flirtujƒÖcych. "
    "Rozmawiasz tylko z osobami 18+. "
    "Jeste≈õ mi≈Çy, uwa≈ºny i flirtujƒÖcy, ale nie opisujesz tre≈õci graficznych."
)

# -------------------
# PAMIƒòƒÜ ROZM√ìW
# -------------------
user_histories = {}  # {user_id: [{"role": ..., "content": ...}, ...]}

# -------------------
# FUNKCJA /start
# -------------------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "üîû Bot 18+\n"
        "PiszƒÖc, potwierdzasz ≈ºe masz uko≈Ñczone 18 lat.\n"
        "Mo≈ºesz teraz pisaƒá do mnie wiadomo≈õci."
    )

# -------------------
# FUNKCJA DO ODPOWIEDZI NA WIADOMO≈öCI
# -------------------
async def chat(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    user_text = update.message.text

    # je≈õli u≈ºytkownik jeszcze nie rozmawia≈Ç, inicjalizuj historiƒô
    if user_id not in user_histories:
        user_histories[user_id] = []

    # dodaj wiadomo≈õƒá u≈ºytkownika do historii
    user_histories[user_id].append({"role": "user", "content": user_text})

    # wywo≈Çanie AI
    try:
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=[{"role": "system", "content": SYSTEM_PROMPT}] + user_histories[user_id]
        )

        reply_text = response.choices[0].message.content

        # ode≈õlij odpowied≈∫ do u≈ºytkownika
        await update.message.reply_text(reply_text)

        # dodaj odpowied≈∫ AI do historii
        user_histories[user_id].append({"role": "assistant", "content": reply_text})

    except Exception as e:
        await update.message.reply_text("Ups, co≈õ posz≈Ço nie tak. Spr√≥buj jeszcze raz.")
        print("B≈ÇƒÖd OpenAI:", e)

# -------------------
# URUCHOMIENIE BOTA
# -------------------
app = ApplicationBuilder().token(BOT_TOKEN).build()

# obs≈Çuga /start
app.add_handler(CommandHandler("start", start))
# obs≈Çuga wszystkich innych wiadomo≈õci
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, chat))

app.run_polling()